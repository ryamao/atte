# 勤務終了

```mermaid
sequenceDiagram
  actor U as ユーザ
  participant B as ブラウザ
  participant A as Web/AP<br>サーバ
  participant D as データベース

  U ->>+ B : http://〇〇/
  note over U, D : ログイン
  note over U, D : 打刻ページの初期化処理
  B -->>- U : 打刻ページ

  U ->>+ B : クリック<br>『勤務終了』
  B ->>+ A : POST /shift/timing
  A ->> A : ユーザ認証→成功
  A ->>+ D : Auth::user()->shiftBegin()
  D -->>- A : ?ShiftBegin $shiftBegin
  A ->>+ D : Auth::user()->breakBegin()
  D -->>- A : ?BreakBegin $breakBegin
  opt !is_null($shiftBegin) && is_null($breakBegin)
    A ->> D : DB::beginTransaction()
    A ->>+ D : ShiftTiming::create<br>w/ 'begun_at' => $shiftBegin->begun_at<br>w/ 'ended_at' => 現在日時
    D -->>- A : ShiftTiming
    A ->>+ D : $shiftBegin->delete()
    D -->>- A : OK
    A ->> D : DB::commit()
  end
  A -->>- B : redirect('/')
  B ->>+ A : GET /
  note over U, D : 打刻ページの初期化処理
  A -->>- B : view('stamping')
  B -->>- U : 打刻ページ
```
