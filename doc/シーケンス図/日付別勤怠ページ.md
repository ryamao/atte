# 日付別勤怠ページ

## クエリストリング無し

```mermaid
sequenceDiagram
  actor U as ユーザ
  participant B as ブラウザ
  participant A as Web/AP<br>サーバ
  participant D as データベース

  U ->>+ B : http://〇〇/
  note over U, D : ログイン
  note over U, D : 打刻ページの初期化処理
  B -->>- U : 打刻ページ

  U ->>+ B : クリック<br>『日付一覧』
  B ->>+ A : GET /attendance
  A ->> A : ユーザ認証→成功
  A ->> A : 現在の年月日を取得
  A ->>+ D : 現在の年月日の勤務時間と<br>現在の年月日の休憩時間を<br>会員IDで内部結合して<br>先頭の5件を取得
  D -->>- A : 会員IDごとの勤務時間と休憩時間
  A ->> A : 会員IDごとの勤怠情報を計算
  A -->>- B : view('attendance')<br>w/ 会員IDごとの勤怠情報
  B -->>- U : 日付別勤怠ページ
```

## クエリストリング有り

```mermaid
sequenceDiagram
  actor U as ユーザ
  participant B as ブラウザ
  participant A as Web/AP<br>サーバ
  participant D as データベース

  U ->>+ B : http://〇〇/
  note over U, D : ログイン
  note over U, D : 打刻ページの初期化処理
  B -->>- U : 打刻ページ

  U ->>+ B : クリック<br>『日付一覧』
  B ->>+ A : GET /attendance<br>?date=2024-01-20<br>&page=3
  A ->> A : ユーザ認証→成功
  A ->>+ D : 2024/01/20の勤務時間と<br>2024/01/20の休憩時間を<br>会員IDで内部結合して<br>1ページ5件として3ページ目を取得
  D -->>- A : 会員IDごとの勤務時間と休憩時間
  A ->> A : 会員IDごとの勤怠情報を計算
  A -->>- B : view('attendance')<br>w/ 会員IDごとの勤怠情報
  B -->>- U : 日付別勤怠ページ
```

## 会員IDごとの勤怠情報

- 勤務開始時刻 = shift_timings.begun_atの時分秒
- 勤務終了時刻 = shift_timings.ended_atの時分秒（nullの場合は「記録がありません」）

### 合計休憩時間

- break_timingsのレコードは年月日を指定して取得している。
- break_timings.user_idでグループ化する
- 各グループのbegun_atとended_atの時間間隔を合計する
- 例外1: ended_atがnullのレコードが存在する場合は「記録がありません」と表示する
- 例外2: 同じuser_idと年月日のbreak_beginsレコードが存在する場合は「記録がありません」と表示する

### 労働時間

- shift_timingsは年月日を指定して取得している
- 仕様上shift_timings.user_idにつき0~1件になるはず。
- user_id別で「begun_atとended_atの時間間隔 - 同じuser_idの合計休憩時間」を計算する
- 例外1: ended_atがnullの場合は「記録がありません」と表示する
- 例外2: 合計休憩時間が「記録がありません」の場合は労働時間も「記録がありません」と表示する
